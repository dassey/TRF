<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Travel Request Form</title>
<style>
    /* Base Styles */
    :root {
        --background-color: #2c2c2e;
        --text-color: #e0e0e0; /* Slightly lighter text */
        --container-bg: #ffffff;
        --container-text: #333333;
        --input-border: #ccc;
        --input-bg: #f9f9f9;
        --primary-color: #007bff;
        --primary-hover: #0056b3;
        --section-border: #dddddd;
        --label-color: #555555;
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; /* System fonts */
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh; /* Use min-height for scroll */
        overflow-y: auto; /* Allow body to scroll if needed */
    }

    .container {
        background-color: var(--container-bg);
        color: var(--container-text);
        max-width: 850px; /* Slightly adjusted max-width */
        width: 95%; /* Use percentage for responsiveness */
        margin: 20px auto; /* Center container and add vertical margin */
        padding: 25px; /* Increased padding */
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        overflow-y: visible; /* Let content dictate height */
    }

    form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
        gap: 20px 25px; /* Row and column gap */
    }

    form h2 {
        grid-column: 1 / -1;
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.8em; /* Slightly larger title */
        color: var(--container-text);
    }

    /* Section Styling */
    .section-header {
        grid-column: 1 / -1;
        font-size: 1.3em;
        font-weight: 600; /* Semibold */
        color: var(--primary-color);
        margin-top: 25px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--primary-color);
    }

     /* Add a specific class for sections needing full width */
    .full-width-section {
        grid-column: 1 / -1;
    }

    /* Inputs, Labels, etc. */
    label {
        display: block; /* Stack labels above inputs */
        font-weight: 600;
        color: var(--label-color);
        font-size: 0.95em;
        margin-bottom: 6px; /* Space below label */
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"], /* Use tel for phone */
    input[type="date"],
    input[type="time"],
    input[type="number"], /* Use number for employee# */
    select,
    textarea {
        width: 100%;
        padding: 12px; /* Increased padding */
        border: 1px solid var(--input-border);
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 1em;
        background-color: var(--input-bg);
        transition: border-color 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
    }

    textarea {
        resize: vertical;
        min-height: 100px;
    }

    /* Checkbox & Radio Styling */
    .checkbox-group, .radio-group {
        display: flex;
        flex-wrap: wrap; /* Allow wrapping */
        gap: 15px; /* Spacing between items */
        grid-column: 1 / -1; /* Span full width */
        align-items: center;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .checkbox-group label, .radio-group label {
        display: flex; /* Align checkbox and text */
        align-items: center;
        font-weight: normal; /* Normal weight for options */
        margin-bottom: 0; /* Reset margin */
        cursor: pointer;
        color: var(--container-text); /* Use container text color */
    }

    input[type="checkbox"], input[type="radio"] {
        margin-right: 8px; /* Space between box and text */
        transform: scale(1.2); /* Slightly larger */
        accent-color: var(--primary-color); /* Modern way to color checkboxes */
        cursor: pointer;
         width: auto; /* Override default width */
    }

     /* Specific Layout Containers */
     .input-group {
        display: flex;
        flex-direction: column; /* Stack label and input */
        gap: 5px; /* Space within the group */
        flex: 1 1 250px; /* Flex properties for responsiveness */
    }

    .row-container {
        grid-column: 1 / -1;
        display: flex;
        flex-wrap: wrap; /* Allow wrapping */
        gap: 20px; /* Space between items in the row */
        align-items: flex-end; /* Align items at the bottom */
    }

    .row-container .input-group { /* Target input groups within a row */
       min-width: 250px; /* Minimum width before wrapping */
    }

    .home-mtc-container {
        /* Let grid handle placement */
    }


    .button-container {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }

    button {
        padding: 14px 35px; /* Adjusted padding */
        border: none;
        border-radius: 5px;
        background-color: var(--primary-color);
        color: #fff;
        font-size: 1.1em; /* Slightly larger font */
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    button:hover {
        background-color: var(--primary-hover);
    }

    /* Conditional Sections */
    .conditional-section {
        display: none; /* Hide by default */
        grid-column: 1 / -1; /* Span full width when shown */
        padding: 15px;
        margin-top: 15px;
        border: 1px solid var(--section-border);
        border-radius: 5px;
        background-color: #fdfdfd; /* Slightly off-white background */
    }

    .conditional-section .section-header,
    .conditional-section .section-subheader {
        margin-top: 0; /* Reset top margin inside conditional */
        padding-bottom: 8px;
        font-size: 1.2em;
        color: var(--label-color);
        border-bottom: 1px solid var(--section-border);
        margin-bottom: 15px;
    }
     .conditional-section .section-subheader {
        font-size: 1.1em;
        font-weight: 600;
        color: var(--container-text);
         margin-top: 15px; /* Add space above subheaders */
    }

    /* ETP/B2B Specific Row */
     .input-group-row {
        grid-column: 1 / -1;
        display: none; /* Hidden by default */
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 10px;
    }
     .input-group-row .input-group {
        min-width: 200px; /* Adjust min-width as needed */
     }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container {
            width: 95%;
            padding: 15px;
            margin-top: 10px; /* Reduce top margin */
        }

        form {
            grid-template-columns: 1fr; /* Single column layout */
            gap: 15px; /* Reduced gap */
        }

        .row-container {
            flex-direction: column; /* Stack items vertically */
            gap: 15px;
            align-items: stretch; /* Stretch items to full width */
        }

         .row-container .input-group {
            min-width: 0; /* Remove min-width on small screens */
        }

        .checkbox-group, .radio-group {
            gap: 10px 15px; /* Adjust gap */
            /* No need to change flex-direction if wrapping is okay */
        }

        form h2 {
            font-size: 1.5em;
        }

        .section-header {
            font-size: 1.2em;
        }

        button {
            width: 100%; /* Full width button */
            padding: 15px;
            font-size: 1em;
        }
         /* Ensure conditional sections still look good */
        .conditional-section {
            padding: 10px;
        }
    }

    @media (max-width: 480px) {
        /* Further refinements for very small screens */
        body {
             font-size: 15px; /* Slightly smaller base font */
        }
        .container {
             width: 100%;
             margin: 0;
             padding: 10px;
             border-radius: 0;
             box-shadow: none;
        }
         input[type="text"], input[type="email"], input[type="tel"],
         input[type="date"], input[type="time"], input[type="number"],
         select, textarea {
            padding: 10px;
        }
         button {
             padding: 12px;
         }
    }

</style>
</head>
<body>
    <div class="container">
        <form id="travelRequestForm">
            <h2>Travel Request Form</h2>

            <div class="section-header full-width-section">Traveler Information</div>

            <div class="input-group home-mtc-container"> <label for="homeMTC">Home MTC</label>
                <select id="homeMTC" name="homeMTC">
                     <option value="" disabled selected>Select MTC</option> <option value="LVN">LVN</option>
                    <option value="HST/MCAT">HST/MCAT</option>
                    <option value="CHF">CHF</option>
                    <option value="DGE">DGE</option>
                    <option value="FIG">FIG</option>
                    <option value="GOW">GOW</option>
                </select>
            </div>

             <div class="input-group"> <label for="travelerName">Name (First Last)</label>
                <input type="text" id="travelerName" name="travelerName" required> </div>

            <div class="input-group">
                <label for="employeeNumber">Employee Number</label>
                <input type="text" id="employeeNumber" name="employeeNumber">
            </div>

            <div class="input-group">
                <label for="travelerEmail">E-mail</label>
                <input type="email" id="travelerEmail" name="travelerEmail" required> </div>

            <div class="input-group">
                <label for="travelerPhone">Phone</label>
                <input type="tel" id="travelerPhone" name="travelerPhone">
            </div>


            <div class="section-header full-width-section">Event Summary</div>
             <div class="input-group">
                <label for="TrainingLocation">Training Location (City, ST)</label>
                <input type="text" id="TrainingLocation" name="TrainingLocation" required> </div>
            <div class="input-group">
                <label for="UID">UID</label>
                <input type="text" id="UID" name="UID" required> </div>
             <div class="input-group">
                <label for="TravelStart">Travel Start Date</label>
                <input type="date" id="TravelStart" name="TravelStart" required> </div>
            <div class="input-group">
                <label for="TravelEnd">Travel End Date</label>
                <input type="date" id="TravelEnd" name="TravelEnd" required> </div>

            <div class="section-header full-width-section">Travel Requirements</div>
            <div class="checkbox-group">
                <label><input type="checkbox" id="AirReservation" name="AirReservation"> Air</label>
                <label><input type="checkbox" id="HotelReservation" name="HotelReservation"> Hotel</label>
                <label><input type="checkbox" id="CarRental" name="CarRental"> Car</label>
                <label><input type="checkbox" id="POV" name="POV"> POV</label>
                <label><input type="checkbox" id="ETP" name="ETP"> ETP</label>
                <label><input type="checkbox" id="B2B" name="B2B"> B2B</label>
            </div>

            <div class="input-group-row">
                <div id="ETPContainer" class="input-group" style="display: none;">
                    <label for="ETPDropdown">ETP Type</label>
                    <select id="ETPDropdown" name="ETPDropdown">
                        <option value="">N/A</option>
                        <option value="PerDiem">Per Diem</option>
                        <option value="RentalVehicle">Rental Vehicle</option>
                        <option value="Baggage">Baggage</option>
                        <option value="Prepositioning">Prepositioning</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div id="B2BContainer" class="input-group" style="display: none;">
                    <label for="B2BUID">B2B UID</label>
                    <input type="text" id="B2BUID" name="B2BUID">
                </div>
            </div>

            <div id="AirSection" class="conditional-section">
                <div class="section-header">Air Reservation</div>
                <div class="radio-group"> <label><input type="radio" id="RoundTrip" name="TripType" value="RoundTrip" checked> Round Trip</label>
                    <label><input type="radio" id="OneWay" name="TripType" value="OneWay"> One Way</label>
                </div>

                <div class="section-subheader">Departing Flight</div>
                <div class="row-container"> <div class="input-group">
                        <label for="DepAirline">Preferred Airline</label>
                        <input type="text" id="DepAirline" name="DepAirline">
                    </div>
                    <div class="input-group">
                        <label for="DepFlight">Preferred Flight #</label>
                        <input type="text" id="DepFlight" name="DepFlight">
                    </div>
                     <div class="input-group">
                        <label for="DepLocation">Depart Airport (Code)</label>
                        <input type="text" id="DepLocation" name="DepLocation">
                    </div>
                     <div class="input-group">
                        <label for="DepArrLocation">Arrive Airport (Code)</label>
                        <input type="text" id="DepArrLocation" name="DepArrLocation">
                    </div>
                    <div class="input-group">
                        <label for="DepDate">Date</label>
                        <input type="date" id="DepDate" name="DepDate">
                    </div>
                    <div class="input-group">
                        <label for="DepTime">Depart Time</label>
                        <input type="time" id="DepTime" name="DepTime">
                    </div>
                    <div class="input-group">
                        <label for="DepArrTime">Arrive Time</label>
                        <input type="time" id="DepArrTime" name="DepArrTime">
                    </div>
                     <div class="input-group full-width-section">
                        <label for="AirNotes">Air Notes (Seat preference, etc.)</label>
                        <input type="text" id="AirNotes" name="AirNotes">
                    </div>
                </div> <div id="AirReturn">
                    <div class="section-subheader">Returning Flight</div>
                    <div class="row-container"> <div class="input-group">
                            <label for="RetAirline">Preferred Airline</label>
                            <input type="text" id="RetAirline" name="RetAirline">
                         </div>
                         <div class="input-group">
                            <label for="RetFlight">Preferred Flight #</label>
                            <input type="text" id="RetFlight" name="RetFlight">
                         </div>
                        <div class="input-group">
                            <label for="RetDepLocation">Depart Airport (Code)</label>
                            <input type="text" id="RetDepLocation" name="RetDepLocation">
                        </div>
                        <div class="input-group">
                            <label for="RetArrLocation">Arrive Airport (Code)</label>
                            <input type="text" id="RetArrLocation" name="RetArrLocation">
                        </div>
                        <div class="input-group">
                            <label for="RetDepDate">Date</label>
                            <input type="date" id="RetDepDate" name="RetDepDate">
                        </div>
                        <div class="input-group">
                            <label for="RetDepTime">Depart Time</label>
                            <input type="time" id="RetDepTime" name="RetDepTime">
                        </div>
                        <div class="input-group">
                            <label for="RetArrTime">Arrive Time</label>
                            <input type="time" id="RetArrTime" name="RetArrTime">
                        </div>
                    </div> </div> </div> <div id="CarSection" class="conditional-section">
                <div class="section-header">Car Rental</div>
                 <div class="checkbox-group"> <label><input type="checkbox" id="OneWayCar" name="OneWayCar"> One Way Rental</label>
                 </div>
                 <div class="row-container"> <div class="input-group">
                        <label for="CarPickUp">Pickup Location</label>
                        <input type="text" id="CarPickUp" name="CarPickUp">
                    </div>
                    <div class="input-group">
                        <label for="CarDate">Pickup Date</label>
                        <input type="date" id="CarDate" name="CarDate">
                    </div>
                    <div class="input-group">
                        <label for="CarPUTime">Pickup Time</label>
                        <input type="time" id="CarPUTime" name="CarPUTime">
                    </div>
                     <div class="input-group">
                        <label for="CarDrop">Drop Off Location</label>
                        <input type="text" id="CarDrop" name="CarDrop">
                    </div>
                    <div class="input-group">
                        <label for="CarDropDate">Drop Off Date</label>
                        <input type="date" id="CarDropDate" name="CarDropDate">
                    </div>
                    <div class="input-group">
                        <label for="CarDropTime">Drop Off Time</label>
                        <input type="time" id="CarDropTime" name="CarDropTime">
                    </div>
                    <div class="input-group full-width-section">
                        <label for="CarNotes">Car Notes (Size preference, etc.)</label>
                        <input type="text" id="CarNotes" name="CarNotes">
                    </div>
                 </div> </div> <div id="HotelSection" class="conditional-section">
                <div class="section-header">Hotel</div>
                <div class="row-container"> <div class="input-group">
                        <label for="TravelerBookedHotel">Traveler Booked Hotel?</label>
                        <select id="TravelerBookedHotel" name="TravelerBookedHotel">
                            <option value="No" selected>No</option> <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="HotelCheckIn">Check-in Date</label>
                        <input type="date" id="HotelCheckIn" name="HotelCheckIn">
                    </div>
                    <div class="input-group">
                        <label for="HotelCheckOut">Check Out Date</label>
                        <input type="date" id="HotelCheckOut" name="HotelCheckOut">
                    </div>
                    <div class="input-group">
                        <label for="HotelLocation">Hotel Name / Location</label>
                        <input type="text" id="HotelLocation" name="HotelLocation">
                    </div>
                     <div class="input-group">
                        <label for="ReservNumber">Reservation # (if booked)</label>
                        <input type="text" id="ReservNumber" name="ReservNumber">
                    </div>
                    <div class="input-group full-width-section">
                        <label for="HotelNotes">Hotel Notes (Loyalty #, preferences)</label>
                        <input type="text" id="HotelNotes" name="HotelNotes">
                    </div>
                 </div> </div> <div class="section-header full-width-section">Comments</div>
            <div class="input-group full-width-section"> <label for="Comments">Additional Comments or Special Instructions</label>
                 <textarea id="Comments" name="Comments"></textarea>
            </div>

            <div class="button-container">
                <button type="submit">Generate PDF</button>
            </div>
        </form>
    </div>

<script src="./pdf-lib.min.js"></script>

<script>
    // Utility to show/hide element by ID
    const setElementDisplay = (id, show) => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = show ? 'block' : 'none'; // Use 'block' for conditional sections
        }
    };

     // Utility to show/hide flex element by ID
    const setFlexElementDisplay = (id, show) => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = show ? 'flex' : 'none'; // Use 'flex' for flex containers
        }
    };

    // Update ETP/B2B Row visibility
    function updateInputGroupRowDisplay() {
        const etpContainer = document.getElementById('ETPContainer');
        const b2bContainer = document.getElementById('B2BContainer');
        const inputGroupRow = document.querySelector('.input-group-row');
        const showRow = (etpContainer.style.display !== 'none' || b2bContainer.style.display !== 'none');
        inputGroupRow.style.display = showRow ? 'flex' : 'none';
    }

    // --- Event Listeners for Conditional Display ---

    // ETP Checkbox
    document.getElementById('ETP').addEventListener('change', function() {
        setFlexElementDisplay('ETPContainer', this.checked);
        updateInputGroupRowDisplay();
    });

    // B2B Checkbox
    document.getElementById('B2B').addEventListener('change', function() {
        setFlexElementDisplay('B2BContainer', this.checked);
        updateInputGroupRowDisplay();
    });

    // Air Reservation Checkbox
    document.getElementById('AirReservation').addEventListener('change', function() {
        const show = this.checked;
        setElementDisplay('AirSection', show);
        // Also trigger display update for round/one way inside air section
        const tripType = document.querySelector('input[name="TripType"]:checked');
        if (tripType) {
            setElementDisplay('AirReturn', show && tripType.value === 'RoundTrip');
        } else {
             setElementDisplay('AirReturn', false); // Hide if no trip type selected (shouldn't happen with radio)
        }
    });

    // Trip Type Radio Buttons (within Air Section)
    document.querySelectorAll('input[name="TripType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Only show return section if AirReservation is checked AND RoundTrip is selected
            const airChecked = document.getElementById('AirReservation').checked;
            setElementDisplay('AirReturn', airChecked && this.value === 'RoundTrip');
        });
    });


    // Car Rental Checkbox
    document.getElementById('CarRental').addEventListener('change', function() {
        setElementDisplay('CarSection', this.checked);
    });

    // Hotel Reservation Checkbox
    document.getElementById('HotelReservation').addEventListener('change', function() {
        setElementDisplay('HotelSection', this.checked);
    });


    // --- Event Listeners for Auto-populating Fields ---

    // Travel Start Date affects DepDate, HotelCheckIn, CarDate
    document.getElementById('TravelStart').addEventListener('change', function() {
        const travelStartDate = this.value;
        document.getElementById('DepDate').value = travelStartDate;
        document.getElementById('HotelCheckIn').value = travelStartDate;
        document.getElementById('CarDate').value = travelStartDate;
    });

    // Travel End Date affects RetDepDate, HotelCheckOut, CarDropDate
    document.getElementById('TravelEnd').addEventListener('change', function() {
        const travelEndDate = this.value;
        document.getElementById('RetDepDate').value = travelEndDate;
        document.getElementById('HotelCheckOut').value = travelEndDate;
        document.getElementById('CarDropDate').value = travelEndDate;
    });

    // Airport Codes sync
    document.getElementById('DepArrLocation').addEventListener('input', function() {
        const locationValue = this.value.toUpperCase(); // Standardize to uppercase
        this.value = locationValue; // Update field itself
        document.getElementById('RetDepLocation').value = locationValue;
        document.getElementById('CarPickUp').value = locationValue; // Assume car pickup is destination airport
    });

    document.getElementById('DepLocation').addEventListener('input', function() {
        const locationValue = this.value.toUpperCase(); // Standardize to uppercase
        this.value = locationValue; // Update field itself
        document.getElementById('RetArrLocation').value = locationValue;
        document.getElementById('CarDrop').value = locationValue; // Assume car drop is origin airport
    });

    // Time Calculations
    const addMinutes = (timeStr, minutesToAdd) => {
        if (!timeStr) return '';
        const [hours, minutes] = timeStr.split(':').map(Number);
        const date = new Date();
        date.setHours(hours, minutes + minutesToAdd, 0, 0); // Set hours and minutes
        const fmtHrs = date.getHours().toString().padStart(2, '0');
        const fmtMins = date.getMinutes().toString().padStart(2, '0');
        return `${fmtHrs}:${fmtMins}`;
    };

    document.getElementById('DepArrTime').addEventListener('input', function() {
        document.getElementById('CarPUTime').value = addMinutes(this.value, 30); // Car pickup 30 mins after arrival
    });

    document.getElementById('RetDepTime').addEventListener('input', function() {
        document.getElementById('CarDropTime').value = addMinutes(this.value, -120); // Car drop 2 hours before departure
    });


    // --- On Page Load ---
    window.addEventListener('load', function() {
        // Trigger change events to set initial visibility
        document.getElementById('AirReservation').dispatchEvent(new Event('change'));
        document.getElementById('CarRental').dispatchEvent(new Event('change'));
        document.getElementById('HotelReservation').dispatchEvent(new Event('change'));
        document.getElementById('ETP').dispatchEvent(new Event('change'));
        document.getElementById('B2B').dispatchEvent(new Event('change'));
        // Ensure radio button state correctly sets return flight visibility
         const tripType = document.querySelector('input[name="TripType"]:checked');
         if (tripType) {
            tripType.dispatchEvent(new Event('change'));
         }


        // Load saved traveler information
        document.getElementById('travelerName').value = localStorage.getItem('travelerName') || '';
        document.getElementById('employeeNumber').value = localStorage.getItem('employeeNumber') || '';
        document.getElementById('travelerEmail').value = localStorage.getItem('travelerEmail') || '';
        document.getElementById('travelerPhone').value = localStorage.getItem('travelerPhone') || '';
        document.getElementById('homeMTC').value = localStorage.getItem('homeMTC') || '';
    });


    // --- Form Submission and PDF Generation ---
    document.getElementById('travelRequestForm').addEventListener('submit', async function (event) {
        event.preventDefault(); // Prevent default form submission

        const formData = new FormData(event.target);
        const { PDFDocument } = PDFLib; // Destructure for easier use

        // --- IMPORTANT: PDF Field Names ---
        // Verify these field names EXACTLY match those in your 'MyFile.pdf' template.
        // Use Adobe Acrobat's "Prepare Form" tool or similar to inspect your PDF.
        const pdfFieldNames = {
            // Traveler Info
            homeMTC: 'Dropdown46', // Example: Update if different
            travelerName: 'Name',
            employeeNumber: 'Employee#',
            travelerPhone: 'Phone',
            travelerEmail: 'Email',
            // Event Summary
            trainingLocation: 'Training Location',
            uid: 'UID',
            travelStart: 'Travel Start',
            travelEnd: 'Travel End',
            // Requirements Checkboxes (CRITICAL TO VERIFY THESE NAMES)
            airReservationCheck: 'Air Reservation',
            hotelReservationCheck: 'Hotel Reservation',
            carRentalCheck: 'Car Rental',
            povCheck: 'POV',
            etpCheck: 'ETP',
            b2bCheck: 'B2B',
            // Air Section
            roundTripCheck: 'Round Trip', // Verify this name
            oneWayCheck: 'One Way', // Verify this name
            depAirline: 'Dep Airline',
            depFlight: 'Dep flight', // Verify exact name
            depLocation: 'Dep location', // Verify exact name
            depArrLocation: 'Dep arr location', // Verify exact name
            depDate: 'Dep Date',
            depTime: 'Dep Time',
            depArrTime: 'Dep arr time', // Verify exact name
            airNotes: 'Air notes', // Verify exact name
            retAirline: 'Ret airline', // Verify exact name
            retFlight: 'Ret flight', // Verify exact name
            retDepLocation: 'Ret dep location', // Verify exact name
            retArrLocation: 'Ret arr location', // Verify exact name
            retDepDate: 'Ret dep date', // Verify exact name
            retDepTime: 'Ret dep time', // Verify exact name
            retArrTime: 'Ret arr time', // Verify exact name
            // Car Section
            oneWayCarCheck: 'One way', // Verify this name (might be different from air's one way)
            carPickUp: 'Car pick up', // Verify exact name
            carDate: 'car date', // Verify exact name
            carPUTime: 'car p/u time', // Verify exact name
            carDrop: 'car drop', // Verify exact name
            carDropDate: 'car drop date', // Verify exact name
            carDropTime: 'car drop time', // Verify exact name
            carNotes: 'car notes', // Verify exact name
            // Hotel Section
            travelerBookedHotel: 'Dropdown41', // Example: Update if different
            hotelCheckIn: 'Hotel check in', // Verify exact name
            hotelCheckOut: 'Hotel check out', // Verify exact name
            reservNumber: 'reserv #', // Verify exact name
            hotelLocation: 'Hotel location', // Verify exact name
            hotelNotes: 'Hotel Notes', // Verify exact name
            // ETP/B2B
            etpDropdown: 'ETP Drop down', // Verify exact name
            b2bUID: 'B2B UID', // Verify exact name
            // Comments
            comments: 'Comments'
        };
        // --- End PDF Field Names ---


        // Save traveler information to localStorage
        localStorage.setItem('travelerName', formData.get('travelerName') || '');
        localStorage.setItem('employeeNumber', formData.get('employeeNumber') || '');
        localStorage.setItem('travelerEmail', formData.get('travelerEmail') || '');
        localStorage.setItem('travelerPhone', formData.get('travelerPhone') || '');
        localStorage.setItem('homeMTC', formData.get('homeMTC') || '');

        try {
            // Load PDF template
            console.log("Loading PDF template: MyFile.pdf");
            const existingPdfBytes = await fetch('MyFile.pdf').then(res => {
                 if (!res.ok) { throw new Error(`Failed to fetch MyFile.pdf: ${res.statusText}`); }
                 return res.arrayBuffer();
            });
            const pdfDoc = await PDFDocument.load(existingPdfBytes);
            const form = pdfDoc.getForm();
            console.log("PDF Template Loaded Successfully.");

            // Helper function to safely set text field value
            const setText = (fieldName, value) => {
                try {
                    if (fieldName && value !== null && value !== undefined) {
                        form.getTextField(fieldName).setText(value.toString());
                    } else if (fieldName) {
                         form.getTextField(fieldName).setText(''); // Clear if no value
                    }
                } catch (e) {
                    console.warn(`Could not find or set text field: ${fieldName}`, e);
                }
            };

            // Helper function to safely select dropdown value
            const setDropdown = (fieldName, value) => {
                try {
                    if (fieldName && value) {
                        form.getDropdown(fieldName).select(value);
                    }
                 } catch (e) {
                    console.warn(`Could not find or set dropdown: ${fieldName}`, e);
                 }
            };

             // Helper function to safely check/uncheck a checkbox
            const setCheckbox = (fieldName, isChecked) => {
                try {
                    if (!fieldName) return;
                    const checkbox = form.getCheckBox(fieldName);
                    console.log(`Setting checkbox '${fieldName}': ${isChecked ? 'Checked' : 'Unchecked'}`);
                    if (isChecked) {
                        checkbox.check();
                    } else {
                        checkbox.uncheck();
                    }
                } catch (e) {
                    console.warn(`Could not find or set checkbox: ${fieldName}`, e);
                }
            };

             // Helper function to safely select radio button value
             // NOTE: pdf-lib handles radio groups slightly differently. Often you check the specific button *within* the group.
             // You might need to find the specific field name for the 'RoundTrip' option and 'OneWay' option within the radio group.
             // For now, we'll map to the checkbox names assuming they might be individual fields. VERIFY THIS.
            const setRadio = (groupName, value) => {
                 try {
                    // Example: Assuming 'Round Trip' and 'One Way' are the actual export values or field names of the options
                    const roundTripFieldName = pdfFieldNames.roundTripCheck; // Placeholder - VERIFY
                    const oneWayFieldName = pdfFieldNames.oneWayCheck; // Placeholder - VERIFY

                    if (value === 'RoundTrip' && roundTripFieldName) {
                         form.getCheckBox(roundTripFieldName).check(); // Or getRadioGroup('GroupName').select('Round Trip') if it's a proper group
                         if(oneWayFieldName) form.getCheckBox(oneWayFieldName).uncheck();
                         console.log(`Setting radio '${groupName}': Round Trip (Field: ${roundTripFieldName})`);
                    } else if (value === 'OneWay' && oneWayFieldName) {
                         form.getCheckBox(oneWayFieldName).check(); // Or getRadioGroup('GroupName').select('One Way')
                         if(roundTripFieldName) form.getCheckBox(roundTripFieldName).uncheck();
                         console.log(`Setting radio '${groupName}': One Way (Field: ${oneWayFieldName})`);
                    } else {
                        // Uncheck both if value is invalid or fields aren't found
                        if(roundTripFieldName) form.getCheckBox(roundTripFieldName).uncheck();
                        if(oneWayFieldName) form.getCheckBox(oneWayFieldName).uncheck();
                         console.log(`Setting radio '${groupName}': Neither selected`);
                    }
                 } catch (e) {
                    console.warn(`Could not set radio button group: ${groupName}`, e);
                 }
            };


            // --- Fill Fields ---
            console.log("Starting to fill PDF fields...");

            // Traveler Info
            setDropdown(pdfFieldNames.homeMTC, formData.get('homeMTC'));
            setText(pdfFieldNames.travelerName, formData.get('travelerName'));
            setText(pdfFieldNames.employeeNumber, formData.get('employeeNumber'));
            setText(pdfFieldNames.travelerPhone, formData.get('travelerPhone'));
            setText(pdfFieldNames.travelerEmail, formData.get('travelerEmail'));

            // Event Summary
            setText(pdfFieldNames.trainingLocation, formData.get('TrainingLocation'));
            setText(pdfFieldNames.uid, formData.get('UID'));
            setText(pdfFieldNames.travelStart, formData.get('TravelStart'));
            setText(pdfFieldNames.travelEnd, formData.get('TravelEnd'));

            // Travel Requirements (Main Checkboxes)
            setCheckbox(pdfFieldNames.airReservationCheck, document.getElementById('AirReservation').checked);
            setCheckbox(pdfFieldNames.hotelReservationCheck, document.getElementById('HotelReservation').checked);
            setCheckbox(pdfFieldNames.carRentalCheck, document.getElementById('CarRental').checked);
            setCheckbox(pdfFieldNames.povCheck, document.getElementById('POV').checked);
            setCheckbox(pdfFieldNames.etpCheck, document.getElementById('ETP').checked);
            setCheckbox(pdfFieldNames.b2bCheck, document.getElementById('B2B').checked);

            // Air Reservation Details
            if (document.getElementById('AirReservation').checked) {
                const tripTypeValue = formData.get('TripType'); // Get value from radio button
                setRadio('TripType', tripTypeValue); // Use the radio helper - VERIFY PDF FIELD NAMES

                setText(pdfFieldNames.depAirline, formData.get('DepAirline'));
                setText(pdfFieldNames.depFlight, formData.get('DepFlight'));
                setText(pdfFieldNames.depLocation, formData.get('DepLocation'));
                setText(pdfFieldNames.depArrLocation, formData.get('DepArrLocation'));
                setText(pdfFieldNames.depDate, formData.get('DepDate'));
                setText(pdfFieldNames.depTime, formData.get('DepTime'));
                setText(pdfFieldNames.depArrTime, formData.get('DepArrTime'));
                setText(pdfFieldNames.airNotes, formData.get('AirNotes'));

                if (tripTypeValue === 'RoundTrip') {
                     setText(pdfFieldNames.retAirline, formData.get('RetAirline'));
                     setText(pdfFieldNames.retFlight, formData.get('RetFlight'));
                     setText(pdfFieldNames.retDepLocation, formData.get('RetDepLocation'));
                     setText(pdfFieldNames.retArrLocation, formData.get('RetArrLocation'));
                     setText(pdfFieldNames.retDepDate, formData.get('RetDepDate'));
                     setText(pdfFieldNames.retDepTime, formData.get('RetDepTime'));
                     setText(pdfFieldNames.retArrTime, formData.get('RetArrTime'));
                }
            }

            // Car Rental Details
            if (document.getElementById('CarRental').checked) {
                 setCheckbox(pdfFieldNames.oneWayCarCheck, document.getElementById('OneWayCar').checked); // Verify PDF field name
                 setText(pdfFieldNames.carPickUp, formData.get('CarPickUp'));
                 setText(pdfFieldNames.carDate, formData.get('CarDate'));
                 setText(pdfFieldNames.carPUTime, formData.get('CarPUTime'));
                 setText(pdfFieldNames.carDrop, formData.get('CarDrop'));
                 setText(pdfFieldNames.carDropDate, formData.get('CarDropDate'));
                 setText(pdfFieldNames.carDropTime, formData.get('CarDropTime'));
                 setText(pdfFieldNames.carNotes, formData.get('CarNotes'));
            }

             // Hotel Reservation Details
            if (document.getElementById('HotelReservation').checked) {
                 setDropdown(pdfFieldNames.travelerBookedHotel, formData.get('TravelerBookedHotel'));
                 setText(pdfFieldNames.hotelCheckIn, formData.get('HotelCheckIn'));
                 setText(pdfFieldNames.hotelCheckOut, formData.get('HotelCheckOut'));
                 setText(pdfFieldNames.reservNumber, formData.get('ReservNumber'));
                 setText(pdfFieldNames.hotelLocation, formData.get('HotelLocation'));
                 setText(pdfFieldNames.hotelNotes, formData.get('HotelNotes'));
            }

             // ETP/B2B Details
             if (document.getElementById('ETP').checked) {
                 setDropdown(pdfFieldNames.etpDropdown, formData.get('ETPDropdown'));
             }
             if (document.getElementById('B2B').checked) {
                 setText(pdfFieldNames.b2bUID, formData.get('B2BUID'));
             }

            // Comments
            setText(pdfFieldNames.comments, formData.get('Comments'));

            console.log("Finished filling fields. Updating appearances...");

            // Update appearance streams for fields
            // form.flatten(); // Uncomment this if checkboxes STILL don't appear - makes fields non-editable!
            form.updateFieldAppearances(); // Usually sufficient

            // --- Generate Filename ---
            const uid = formData.get('UID')?.trim().replace(/[^a-zA-Z0-9_-]/g, '') || 'NO_UID'; // Sanitize UID
            const travelerName = formData.get('travelerName')?.trim() || 'NO_NAME';
            const travelStart = formData.get('TravelStart') || '';

            let lastNameFirstInitial = 'UNKNOWN';
            if (travelerName.includes(' ')) {
                const nameParts = travelerName.split(' ').filter(part => part.length > 0); // Handle multiple spaces
                const lastName = nameParts[nameParts.length - 1].toUpperCase();
                const firstInitial = nameParts[0].charAt(0).toUpperCase();
                lastNameFirstInitial = `${lastName}${firstInitial}`;
            } else if (travelerName.length > 0) {
                 lastNameFirstInitial = travelerName.toUpperCase(); // Handle single names
            }

            let formattedDate = 'NO_DATE';
            if (travelStart) {
                 try {
                    // Ensure date is parsed correctly, accounting for potential timezone issues if needed
                    const dateParts = travelStart.split('-'); // YYYY-MM-DD
                    const dateObj = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])); // Use UTC to avoid timezone shifts
                    const day = dateObj.getUTCDate().toString().padStart(2, '0');
                    const month = dateObj.toLocaleString('en-US', { month: 'short', timeZone: 'UTC' }).toUpperCase();
                    const year = dateObj.getUTCFullYear().toString().slice(-2);
                    formattedDate = `${day}_${month}_${year}`;
                 } catch (e) {
                     console.warn("Could not format date:", travelStart, e);
                     formattedDate = travelStart.replace(/-/g, '_'); // Fallback format
                 }
            }

            const fileName = `${uid}_HST_${lastNameFirstInitial}_${formattedDate}.pdf`;
            console.log(`Generated filename: ${fileName}`);

            // Serialize the PDF document
            console.log("Saving PDF document...");
            const pdfBytes = await pdfDoc.save();
            console.log("PDF Saved. Triggering download...");

            // Trigger download
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up

            console.log("Download triggered.");

        } catch (error) {
            console.error('Error during PDF generation:', error);
            alert(`An error occurred while processing the PDF: ${error.message}`);
        }
    });

</script>
</body>
</html>
