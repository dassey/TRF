<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Travel Request Form</title>

<style>
/* ---------- Core palette ---------- */
:root{
  --background-color:#2c2c2e;
  --text-color:#e0e0e0;
  --container-bg:#ffffff;
  --container-text:#333333;
  --input-border:#ccc;
  --input-bg:#f9f9f9;
  --primary-color:#007bff;
  --primary-hover:#0056b3;
  --section-border:#dddddd;
  --label-color:#555555;

  /* touch ergonomics */
  --touch-target:44px;        /* WCAG/Apple minimum */
}

/* remove grey iOS flash */
*{-webkit-tap-highlight-color:rgba(0,0,0,0);}

body{
  background:var(--background-color);
  color:var(--text-color);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  margin:0;padding:0;
  display:flex;justify-content:center;align-items:flex-start;
  min-height:100vh;
  overflow-y:auto;
}

.container{
  background:var(--container-bg);
  color:var(--container-text);
  max-width:850px;width:95%;
  margin:20px auto;
  padding:25px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  overflow-y:visible;
}

/* ---------- GRID LAYOUT ---------- */
form{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px 25px;
}
form h2{
  grid-column:1/-1;text-align:center;margin-bottom:25px;
  font-size:clamp(1.4rem,1.1vw+1rem,2.2rem);
}
.section-header{
  grid-column:1/-1;
  font-size:clamp(1.1rem,.9vw+1rem,1.6rem);
  font-weight:600;
  color:var(--primary-color);
  margin-top:25px;padding-bottom:8px;
  border-bottom:2px solid var(--primary-color);
}
.full-width-section{grid-column:1/-1}

/* ---------- INPUTS ---------- */
label{
  display:block;font-weight:600;color:var(--label-color);
  font-size:.95em;margin-bottom:6px;
}
input:not([type=checkbox]):not([type=radio]),
select,textarea{
  width:100%;padding:.65rem .75rem;          /* bigger rhythm */
  border:1px solid var(--input-border);
  border-radius:5px;box-sizing:border-box;
  font-size:1em;background:var(--input-bg);
  min-block-size:var(--touch-target);
  transition:border-color .2s ease;
}
input:focus,select:focus,textarea:focus{
  border-color:var(--primary-color);outline:none;
  box-shadow:0 0 0 2px rgba(0,123,255,.2);
}
textarea{resize:vertical;min-height:100px}

/* ---------- TOUCH-TARGET WRAPPER ---------- */
.touch-target{
  display:inline-flex;align-items:center;gap:.5rem;
  padding:.5rem .75rem;min-block-size:var(--touch-target);
  cursor:pointer;user-select:none;
}
.touch-target:active{transform:scale(.96);transition:transform 80ms cubic-bezier(.4,0,.2,1);}
.touch-target:has(:focus-visible){outline:3px solid var(--primary-color);outline-offset:2px;}
@media (prefers-reduced-motion:reduce){
  .touch-target:active{transition:none;}
}

/* custom checkbox / radio */
input[type=checkbox],input[type=radio]{
  appearance:none;inline-size:1.2rem;block-size:1.2rem;
  border:2px solid var(--primary-color);border-radius:.25rem;
  position:relative;margin:0;cursor:pointer;
}
input[type=checkbox]:checked::after,input[type=radio]:checked::after{
  content:"";position:absolute;inset:0;
  background:var(--primary-color);border-radius:inherit;
}
input[type=radio]{border-radius:50%;}
input[type=radio]::after{border-radius:50%;}

/* groups */
.checkbox-group,.radio-group{
  display:flex;flex-wrap:wrap;gap:15px;
  grid-column:1/-1;align-items:center;margin:10px 0;
}
.checkbox-group label,.radio-group label{
  font-weight:normal;margin:0;color:var(--container-text);
}

/* layout helpers */
.input-group{display:flex;flex-direction:column;gap:5px;flex:1 1 250px;}
.row-container{grid-column:1/-1;display:flex;flex-wrap:wrap;gap:20px;align-items:flex-end;}
.row-container .input-group{min-width:250px}
.button-container{grid-column:1/-1;display:flex;justify-content:center;margin-top:30px;}

/* button */
button{
  padding:14px 35px;border:none;border-radius:5px;
  background:var(--primary-color);color:#fff;
  font-size:1.1em;font-weight:600;cursor:pointer;
  min-block-size:var(--touch-target);
  transition:background-color .2s ease;
}
button:hover{background:var(--primary-hover);}

/* conditional blocks */
.conditional-section{display:none;grid-column:1/-1;padding:15px;margin-top:15px;
  border:1px solid var(--section-border);border-radius:5px;background:#fdfdfd;}
.conditional-section .section-header,
.conditional-section .section-subheader{margin-top:0;padding-bottom:8px;font-size:1.2em;
  color:var(--label-color);border-bottom:1px solid var(--section-border);margin-bottom:15px;}
.conditional-section .section-subheader{font-size:1.1em;font-weight:600;color:var(--container-text);margin-top:15px;}

/* responsive tweaks */
@media(max-width:768px){
  .container{width:95%;padding:15px;margin-top:10px}
  form{grid-template-columns:1fr;gap:15px}
  .row-container{flex-direction:column;gap:15px;align-items:stretch}
  .row-container .input-group{min-width:0}
  button{width:100%;padding:15px;font-size:1em}
  .conditional-section{padding:10px}
}
@media(max-width:480px){
  body{font-size:15px}
  .container{width:100%;margin:0;padding:10px;border-radius:0;box-shadow:none}
  input:not([type=checkbox]):not([type=radio]),select,textarea{padding:10px}
  button{padding:12px}
}
</style>
</head>

<body>
<div class="container">
<form id="travelRequestForm">
  <h2>Travel Request Form</h2>

  <div class="section-header full-width-section">Traveler Information</div>

  <div class="input-group home-mtc-container">
    <label for="homeMTC">Home MTC</label>
    <select id="homeMTC" name="homeMTC"
            autocomplete="organization">
      <option value="" disabled selected>Select MTC</option>
      <option value="LVN">LVN</option>
      <option value="HST/MCAT">HST/MCAT</option>
      <option value="CHF">CHF</option>
      <option value="DGE">DGE</option>
      <option value="FIG">FIG</option>
      <option value="GOW">GOW</option>
    </select>
  </div>

  <div class="input-group">
    <label for="travelerName">Name (First Last)</label>
    <input type="text" id="travelerName" name="travelerName"
           autocomplete="name" required>
  </div>

  <div class="input-group">
    <label for="employeeNumber">Employee Number</label>
    <input type="text" id="employeeNumber" name="employeeNumber"
           inputmode="numeric" pattern="[0-9]*" autocomplete="off">
  </div>

  <div class="input-group">
    <label for="travelerEmail">E-mail</label>
    <input type="email" id="travelerEmail" name="travelerEmail"
           inputmode="email" autocomplete="email" required>
  </div>

  <div class="input-group">
    <label for="travelerPhone">Phone</label>
    <input type="tel" id="travelerPhone" name="travelerPhone"
           inputmode="tel" autocomplete="tel-national">
  </div>

  <div class="section-header full-width-section">Event Summary</div>

  <div class="input-group">
    <label for="TrainingLocation">Training Location (City, ST)</label>
    <input type="text" id="TrainingLocation" name="TrainingLocation" required>
  </div>
  <div class="input-group">
    <label for="UID">UID</label>
    <input type="text" id="UID" name="UID" required>
  </div>
  <div class="input-group">
    <label for="TravelStart">Travel Start Date</label>
    <input type="date" id="TravelStart" name="TravelStart" required>
  </div>
  <div class="input-group">
    <label for="TravelEnd">Travel End Date</label>
    <input type="date" id="TravelEnd" name="TravelEnd" required>
  </div>

  <div class="section-header full-width-section">Travel Requirements</div>
  <div class="checkbox-group">
    <label class="touch-target"><input type="checkbox" id="AirReservation" name="AirReservation">Air</label>
    <label class="touch-target"><input type="checkbox" id="HotelReservation" name="HotelReservation">Hotel</label>
    <label class="touch-target"><input type="checkbox" id="CarRental" name="CarRental">Car</label>
    <label class="touch-target"><input type="checkbox" id="POV" name="POV">POV</label>
    <label class="touch-target"><input type="checkbox" id="ETP" name="ETP">ETP</label>
    <label class="touch-target"><input type="checkbox" id="B2B" name="B2B">B2B</label>
  </div>

  <!-- ETP / B2B row -->
  <div class="input-group-row">
    <div id="ETPContainer" class="input-group" style="display:none;">
      <label for="ETPDropdown">ETP Type</label>
      <select id="ETPDropdown" name="ETPDropdown">
        <option value="">N/A</option>
        <option value="PerDiem">Per Diem</option>
        <option value="RentalVehicle">Rental Vehicle</option>
        <option value="Baggage">Baggage</option>
        <option value="Prepositioning">Prepositioning</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div id="B2BContainer" class="input-group" style="display:none;">
      <label for="B2BUID">B2B UID</label>
      <input type="text" id="B2BUID" name="B2BUID">
    </div>
  </div>

  <!-- ===================== AIR SECTION ===================== -->
  <div id="AirSection" class="conditional-section">
    <div class="section-header">Air Reservation</div>
    <div class="radio-group">
      <label class="touch-target"><input type="radio" id="RoundTrip" name="TripType" value="RoundTrip" checked>Round Trip</label>
      <label class="touch-target"><input type="radio" id="OneWay"   name="TripType" value="OneWay">One Way</label>
    </div>

    <div class="section-subheader">Departing Flight</div>
    <div class="row-container">
      <div class="input-group"><label for="DepAirline">Preferred Airline</label><input type="text" id="DepAirline" name="DepAirline"></div>
      <div class="input-group"><label for="DepFlight">Preferred Flight #</label><input type="text" id="DepFlight" name="DepFlight"></div>
      <div class="input-group"><label for="DepLocation">Depart Airport (Code)</label><input type="text" id="DepLocation" name="DepLocation"></div>
      <div class="input-group"><label for="DepArrLocation">Arrive Airport (Code)</label><input type="text" id="DepArrLocation" name="DepArrLocation"></div>
      <div class="input-group"><label for="DepDate">Date</label><input type="date" id="DepDate" name="DepDate"></div>
      <div class="input-group"><label for="DepTime">Depart Time</label><input type="time" id="DepTime" name="DepTime"></div>
      <div class="input-group"><label for="DepArrTime">Arrive Time</label><input type="time" id="DepArrTime" name="DepArrTime"></div>
      <div class="input-group full-width-section"><label for="AirNotes">Air Notes (Seat preference, etc.)</label><input type="text" id="AirNotes" name="AirNotes"></div>
    </div>

    <div id="AirReturn">
      <div class="section-subheader">Returning Flight</div>
      <div class="row-container">
        <div class="input-group"><label for="RetAirline">Preferred Airline</label><input type="text" id="RetAirline" name="RetAirline"></div>
        <div class="input-group"><label for="RetFlight">Preferred Flight #</label><input type="text" id="RetFlight" name="RetFlight"></div>
        <div class="input-group"><label for="RetDepLocation">Depart Airport (Code)</label><input type="text" id="RetDepLocation" name="RetDepLocation"></div>
        <div class="input-group"><label for="RetArrLocation">Arrive Airport (Code)</label><input type="text" id="RetArrLocation" name="RetArrLocation"></div>
        <div class="input-group"><label for="RetDepDate">Date</label><input type="date" id="RetDepDate" name="RetDepDate"></div>
        <div class="input-group"><label for="RetDepTime">Depart Time</label><input type="time" id="RetDepTime" name="RetDepTime"></div>
        <div class="input-group"><label for="RetArrTime">Arrive Time</label><input type="time" id="RetArrTime" name="RetArrTime"></div>
      </div>
    </div>
  </div>

  <!-- ===================== CAR SECTION ===================== -->
  <div id="CarSection" class="conditional-section">
    <div class="section-header">Car Rental</div>
    <div class="checkbox-group">
      <label class="touch-target"><input type="checkbox" id="OneWayCar" name="OneWayCar">One Way Rental</label>
    </div>
    <div class="row-container">
      <div class="input-group"><label for="CarPickUp">Pickup Location</label><input type="text" id="CarPickUp" name="CarPickUp"></div>
      <div class="input-group"><label for="CarDate">Pickup Date</label><input type="date" id="CarDate" name="CarDate"></div>
      <div class="input-group"><label for="CarPUTime">Pickup Time</label><input type="time" id="CarPUTime" name="CarPUTime"></div>
      <div class="input-group"><label for="CarDrop">Drop Off Location</label><input type="text" id="CarDrop" name="CarDrop"></div>
      <div class="input-group"><label for="CarDropDate">Drop Off Date</label><input type="date" id="CarDropDate" name="CarDropDate"></div>
      <div class="input-group"><label for="CarDropTime">Drop Off Time</label><input type="time" id="CarDropTime" name="CarDropTime"></div>
      <div class="input-group full-width-section"><label for="CarNotes">Car Notes (Size preference, etc.)</label><input type="text" id="CarNotes" name="CarNotes"></div>
    </div>
  </div>

  <!-- ===================== HOTEL SECTION ===================== -->
  <div id="HotelSection" class="conditional-section">
    <div class="section-header">Hotel</div>
    <div class="row-container">
      <div class="input-group">
        <label for="TravelerBookedHotel">Traveler Booked Hotel?</label>
        <select id="TravelerBookedHotel" name="TravelerBookedHotel">
          <option value="No" selected>No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>
      <div class="input-group"><label for="HotelCheckIn">Check-in Date</label><input type="date" id="HotelCheckIn" name="HotelCheckIn"></div>
      <div class="input-group"><label for="HotelCheckOut">Check Out Date</label><input type="date" id="HotelCheckOut" name="HotelCheckOut"></div>
      <div class="input-group"><label for="HotelLocation">Hotel Name / Location</label><input type="text" id="HotelLocation" name="HotelLocation"></div>
      <div class="input-group"><label for="ReservNumber">Reservation # (if booked)</label><input type="text" id="ReservNumber" name="ReservNumber"></div>
      <div class="input-group full-width-section"><label for="HotelNotes">Hotel Notes (Loyalty #, preferences)</label><input type="text" id="HotelNotes" name="HotelNotes"></div>
    </div>
  </div>

  <div class="section-header full-width-section">Comments</div>
  <div class="input-group full-width-section">
    <label for="Comments">Additional Comments or Special Instructions</label>
    <textarea id="Comments" name="Comments"></textarea>
  </div>

  <div class="button-container"><button type="submit">Generate PDF</button></div>
</form>
</div>

<!-- -------------------- SCRIPTS -------------------- -->
<script src="./pdf-lib.min.js"></script>
<script>
/* ========== helper for display toggles ========== */
const setElementDisplay=(id,show)=>{const e=document.getElementById(id);if(e)e.style.display=show?'block':'none'};
const setFlexElementDisplay=(id,show)=>{const e=document.getElementById(id);if(e)e.style.display=show?'flex':'none'};
function updateInputGroupRowDisplay(){
  const show=document.getElementById('ETPContainer').style.display!=='none'||document.getElementById('B2BContainer').style.display!=='none';
  document.querySelector('.input-group-row').style.display=show?'flex':'none';
}

/* ========== checkbox/radio change events ========== */
document.getElementById('ETP').addEventListener('change',function(){setFlexElementDisplay('ETPContainer',this.checked);updateInputGroupRowDisplay()});
document.getElementById('B2B').addEventListener('change',function(){setFlexElementDisplay('B2BContainer',this.checked);updateInputGroupRowDisplay()});
document.getElementById('AirReservation').addEventListener('change',function(){
  const show=this.checked;setElementDisplay('AirSection',show);
  const trip=document.querySelector('input[name="TripType"]:checked');
  setElementDisplay('AirReturn',show&&trip&&trip.value==='RoundTrip');
});
document.querySelectorAll('input[name="TripType"]').forEach(r=>r.addEventListener('change',function(){
  setElementDisplay('AirReturn',document.getElementById('AirReservation').checked&&this.value==='RoundTrip');
}));
document.getElementById('CarRental').addEventListener('change',function(){setElementDisplay('CarSection',this.checked)});
document.getElementById('HotelReservation').addEventListener('change',function(){setElementDisplay('HotelSection',this.checked)});

/* ========== field auto-sync ========== */
const addMinutes=(t,m)=>{if(!t)return'';const[d,h]=t.split(':').map(Number);const dt=new Date();dt.setHours(d,h+m,0,0);return`${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`};

document.getElementById('TravelStart').addEventListener('change',e=>{
  ['DepDate','HotelCheckIn','CarDate'].forEach(id=>document.getElementById(id).value=e.target.value);
});
document.getElementById('TravelEnd').addEventListener('change',e=>{
  ['RetDepDate','HotelCheckOut','CarDropDate'].forEach(id=>document.getElementById(id).value=e.target.value);
});
document.getElementById('DepArrLocation').addEventListener('input',e=>{
  const v=e.target.value.toUpperCase();e.target.value=v;['RetDepLocation','CarPickUp'].forEach(id=>document.getElementById(id).value=v);
});
document.getElementById('DepLocation').addEventListener('input',e=>{
  const v=e.target.value.toUpperCase();e.target.value=v;['RetArrLocation','CarDrop'].forEach(id=>document.getElementById(id).value=v);
});
document.getElementById('DepArrTime').addEventListener('input',e=>document.getElementById('CarPUTime').value=addMinutes(e.target.value,30));
document.getElementById('RetDepTime').addEventListener('input',e=>document.getElementById('CarDropTime').value=addMinutes(e.target.value,-120));

/* ========== on load ========== */
window.addEventListener('load',()=>{
  ['AirReservation','CarRental','HotelReservation','ETP','B2B'].forEach(id=>document.getElementById(id).dispatchEvent(new Event('change')));
  const trip=document.querySelector('input[name="TripType"]:checked');if(trip)trip.dispatchEvent(new Event('change'));
  ['travelerName','employeeNumber','travelerEmail','travelerPhone','homeMTC'].forEach(id=>document.getElementById(id).value=localStorage.getItem(id)||'');

  /* optional haptic feedback */
  if(navigator.vibrate){
    document.querySelectorAll('.touch-target').forEach(l=>l.addEventListener('click',()=>navigator.vibrate(10)));
  }
});

    // --- Form Submission and PDF Generation ---
    document.getElementById('travelRequestForm').addEventListener('submit', async function (event) {
        event.preventDefault(); // Prevent default form submission

        const formData = new FormData(event.target);
        const { PDFDocument } = PDFLib; // Destructure for easier use

        // --- IMPORTANT: PDF Field Names ---
        // Verify these field names EXACTLY match those in your 'MyFile.pdf' template.
        // Use Adobe Acrobat's "Prepare Form" tool or similar to inspect your PDF.
        const pdfFieldNames = {
            // Traveler Info
            homeMTC: 'Dropdown46', // Example: Update if different
            travelerName: 'Name',
            employeeNumber: 'Employee#',
            travelerPhone: 'Phone',
            travelerEmail: 'Email',
            // Event Summary
            trainingLocation: 'Training Location',
            uid: 'UID',
            travelStart: 'Travel Start',
            travelEnd: 'Travel End',
            // Requirements Checkboxes (CRITICAL TO VERIFY THESE NAMES)
            airReservationCheck: 'Air Reservation',
            hotelReservationCheck: 'Hotel Reservation',
            carRentalCheck: 'Car Rental',
            povCheck: 'POV',
            etpCheck: 'ETP',
            b2bCheck: 'B2B',
            // Air Section
            roundTripCheck: 'Round Trip', // Verify this name
            oneWayCheck: 'One Way', // Verify this name
            depAirline: 'Dep Airline',
            depFlight: 'Dep flight', // Verify exact name
            depLocation: 'Dep location', // Verify exact name
            depArrLocation: 'Dep arr location', // Verify exact name
            depDate: 'Dep Date',
            depTime: 'Dep Time',
            depArrTime: 'Dep arr time', // Verify exact name
            airNotes: 'Air notes', // Verify exact name
            retAirline: 'Ret airline', // Verify exact name
            retFlight: 'Ret flight', // Verify exact name
            retDepLocation: 'Ret dep location', // Verify exact name
            retArrLocation: 'Ret arr location', // Verify exact name
            retDepDate: 'Ret dep date', // Verify exact name
            retDepTime: 'Ret dep time', // Verify exact name
            retArrTime: 'Ret arr time', // Verify exact name
            // Car Section
            oneWayCarCheck: 'One way', // Verify this name (might be different from air's one way)
            carPickUp: 'Car pick up', // Verify exact name
            carDate: 'car date', // Verify exact name
            carPUTime: 'car p/u time', // Verify exact name
            carDrop: 'car drop', // Verify exact name
            carDropDate: 'car drop date', // Verify exact name
            carDropTime: 'car drop time', // Verify exact name
            carNotes: 'car notes', // Verify exact name
            // Hotel Section
            travelerBookedHotel: 'Dropdown41', // Example: Update if different
            hotelCheckIn: 'Hotel check in', // Verify exact name
            hotelCheckOut: 'Hotel check out', // Verify exact name
            reservNumber: 'reserv #', // Verify exact name
            hotelLocation: 'Hotel location', // Verify exact name
            hotelNotes: 'Hotel Notes', // Verify exact name
            // ETP/B2B
            etpDropdown: 'ETP Drop down', // Verify exact name
            b2bUID: 'B2B UID', // Verify exact name
            // Comments
            comments: 'Comments'
        };
        // --- End PDF Field Names ---


        // Save traveler information to localStorage
        localStorage.setItem('travelerName', formData.get('travelerName') || '');
        localStorage.setItem('employeeNumber', formData.get('employeeNumber') || '');
        localStorage.setItem('travelerEmail', formData.get('travelerEmail') || '');
        localStorage.setItem('travelerPhone', formData.get('travelerPhone') || '');
        localStorage.setItem('homeMTC', formData.get('homeMTC') || '');

        try {
            // Load PDF template
            console.log("Loading PDF template: MyFile.pdf");
            const existingPdfBytes = await fetch('MyFile.pdf').then(res => {
                 if (!res.ok) { throw new Error(`Failed to fetch MyFile.pdf: ${res.statusText}`); }
                 return res.arrayBuffer();
            });
            const pdfDoc = await PDFDocument.load(existingPdfBytes);
            const form = pdfDoc.getForm();
            console.log("PDF Template Loaded Successfully.");

            // Helper function to safely set text field value
            const setText = (fieldName, value) => {
                try {
                    if (fieldName && value !== null && value !== undefined) {
                        form.getTextField(fieldName).setText(value.toString());
                    } else if (fieldName) {
                         form.getTextField(fieldName).setText(''); // Clear if no value
                    }
                } catch (e) {
                    console.warn(`Could not find or set text field: ${fieldName}`, e);
                }
            };

            // Helper function to safely select dropdown value
            const setDropdown = (fieldName, value) => {
                try {
                    if (fieldName && value) {
                        form.getDropdown(fieldName).select(value);
                    }
                 } catch (e) {
                    console.warn(`Could not find or set dropdown: ${fieldName}`, e);
                 }
            };

             // Helper function to safely check/uncheck a checkbox
            const setCheckbox = (fieldName, isChecked) => {
                try {
                    if (!fieldName) return;
                    const checkbox = form.getCheckBox(fieldName);
                    console.log(`Setting checkbox '${fieldName}': ${isChecked ? 'Checked' : 'Unchecked'}`);
                    if (isChecked) {
                        checkbox.check();
                    } else {
                        checkbox.uncheck();
                    }
                } catch (e) {
                    console.warn(`Could not find or set checkbox: ${fieldName}`, e);
                }
            };

             // Helper function to safely select radio button value
             // NOTE: pdf-lib handles radio groups slightly differently. Often you check the specific button *within* the group.
             // You might need to find the specific field name for the 'RoundTrip' option and 'OneWay' option within the radio group.
             // For now, we'll map to the checkbox names assuming they might be individual fields. VERIFY THIS.
            const setRadio = (groupName, value) => {
                 try {
                    // Example: Assuming 'Round Trip' and 'One Way' are the actual export values or field names of the options
                    const roundTripFieldName = pdfFieldNames.roundTripCheck; // Placeholder - VERIFY
                    const oneWayFieldName = pdfFieldNames.oneWayCheck; // Placeholder - VERIFY

                    if (value === 'RoundTrip' && roundTripFieldName) {
                         form.getCheckBox(roundTripFieldName).check(); // Or getRadioGroup('GroupName').select('Round Trip') if it's a proper group
                         if(oneWayFieldName) form.getCheckBox(oneWayFieldName).uncheck();
                         console.log(`Setting radio '${groupName}': Round Trip (Field: ${roundTripFieldName})`);
                    } else if (value === 'OneWay' && oneWayFieldName) {
                         form.getCheckBox(oneWayFieldName).check(); // Or getRadioGroup('GroupName').select('One Way')
                         if(roundTripFieldName) form.getCheckBox(roundTripFieldName).uncheck();
                         console.log(`Setting radio '${groupName}': One Way (Field: ${oneWayFieldName})`);
                    } else {
                        // Uncheck both if value is invalid or fields aren't found
                        if(roundTripFieldName) form.getCheckBox(roundTripFieldName).uncheck();
                        if(oneWayFieldName) form.getCheckBox(oneWayFieldName).uncheck();
                         console.log(`Setting radio '${groupName}': Neither selected`);
                    }
                 } catch (e) {
                    console.warn(`Could not set radio button group: ${groupName}`, e);
                 }
            };


            // --- Fill Fields ---
            console.log("Starting to fill PDF fields...");

            // Traveler Info
            setDropdown(pdfFieldNames.homeMTC, formData.get('homeMTC'));
            setText(pdfFieldNames.travelerName, formData.get('travelerName'));
            setText(pdfFieldNames.employeeNumber, formData.get('employeeNumber'));
            setText(pdfFieldNames.travelerPhone, formData.get('travelerPhone'));
            setText(pdfFieldNames.travelerEmail, formData.get('travelerEmail'));

            // Event Summary
            setText(pdfFieldNames.trainingLocation, formData.get('TrainingLocation'));
            setText(pdfFieldNames.uid, formData.get('UID'));
            setText(pdfFieldNames.travelStart, formData.get('TravelStart'));
            setText(pdfFieldNames.travelEnd, formData.get('TravelEnd'));

            // Travel Requirements (Main Checkboxes)
            setCheckbox(pdfFieldNames.airReservationCheck, document.getElementById('AirReservation').checked);
            setCheckbox(pdfFieldNames.hotelReservationCheck, document.getElementById('HotelReservation').checked);
            setCheckbox(pdfFieldNames.carRentalCheck, document.getElementById('CarRental').checked);
            setCheckbox(pdfFieldNames.povCheck, document.getElementById('POV').checked);
            setCheckbox(pdfFieldNames.etpCheck, document.getElementById('ETP').checked);
            setCheckbox(pdfFieldNames.b2bCheck, document.getElementById('B2B').checked);

            // Air Reservation Details
            if (document.getElementById('AirReservation').checked) {
                const tripTypeValue = formData.get('TripType'); // Get value from radio button
                setRadio('TripType', tripTypeValue); // Use the radio helper - VERIFY PDF FIELD NAMES

                setText(pdfFieldNames.depAirline, formData.get('DepAirline'));
                setText(pdfFieldNames.depFlight, formData.get('DepFlight'));
                setText(pdfFieldNames.depLocation, formData.get('DepLocation'));
                setText(pdfFieldNames.depArrLocation, formData.get('DepArrLocation'));
                setText(pdfFieldNames.depDate, formData.get('DepDate'));
                setText(pdfFieldNames.depTime, formData.get('DepTime'));
                setText(pdfFieldNames.depArrTime, formData.get('DepArrTime'));
                setText(pdfFieldNames.airNotes, formData.get('AirNotes'));

                if (tripTypeValue === 'RoundTrip') {
                     setText(pdfFieldNames.retAirline, formData.get('RetAirline'));
                     setText(pdfFieldNames.retFlight, formData.get('RetFlight'));
                     setText(pdfFieldNames.retDepLocation, formData.get('RetDepLocation'));
                     setText(pdfFieldNames.retArrLocation, formData.get('RetArrLocation'));
                     setText(pdfFieldNames.retDepDate, formData.get('RetDepDate'));
                     setText(pdfFieldNames.retDepTime, formData.get('RetDepTime'));
                     setText(pdfFieldNames.retArrTime, formData.get('RetArrTime'));
                }
            }

            // Car Rental Details
            if (document.getElementById('CarRental').checked) {
                 setCheckbox(pdfFieldNames.oneWayCarCheck, document.getElementById('OneWayCar').checked); // Verify PDF field name
                 setText(pdfFieldNames.carPickUp, formData.get('CarPickUp'));
                 setText(pdfFieldNames.carDate, formData.get('CarDate'));
                 setText(pdfFieldNames.carPUTime, formData.get('CarPUTime'));
                 setText(pdfFieldNames.carDrop, formData.get('CarDrop'));
                 setText(pdfFieldNames.carDropDate, formData.get('CarDropDate'));
                 setText(pdfFieldNames.carDropTime, formData.get('CarDropTime'));
                 setText(pdfFieldNames.carNotes, formData.get('CarNotes'));
            }

             // Hotel Reservation Details
            if (document.getElementById('HotelReservation').checked) {
                 setDropdown(pdfFieldNames.travelerBookedHotel, formData.get('TravelerBookedHotel'));
                 setText(pdfFieldNames.hotelCheckIn, formData.get('HotelCheckIn'));
                 setText(pdfFieldNames.hotelCheckOut, formData.get('HotelCheckOut'));
                 setText(pdfFieldNames.reservNumber, formData.get('ReservNumber'));
                 setText(pdfFieldNames.hotelLocation, formData.get('HotelLocation'));
                 setText(pdfFieldNames.hotelNotes, formData.get('HotelNotes'));
            }

             // ETP/B2B Details
             if (document.getElementById('ETP').checked) {
                 setDropdown(pdfFieldNames.etpDropdown, formData.get('ETPDropdown'));
             }
             if (document.getElementById('B2B').checked) {
                 setText(pdfFieldNames.b2bUID, formData.get('B2BUID'));
             }

            // Comments
            setText(pdfFieldNames.comments, formData.get('Comments'));

            console.log("Finished filling fields. Updating appearances...");

            // Update appearance streams for fields
            //form.flatten(); // Uncomment this if checkboxes STILL don't appear - makes fields non-editable!
            form.updateFieldAppearances(); // Usually sufficient

            // --- Generate Filename ---
            const uid = formData.get('UID')?.trim().replace(/[^a-zA-Z0-9_-]/g, '') || 'NO_UID'; // Sanitize UID
            const travelerName = formData.get('travelerName')?.trim() || 'NO_NAME';
            const travelStart = formData.get('TravelStart') || '';

            let lastNameFirstInitial = 'UNKNOWN';
            if (travelerName.includes(' ')) {
                const nameParts = travelerName.split(' ').filter(part => part.length > 0); // Handle multiple spaces
                const lastName = nameParts[nameParts.length - 1].toUpperCase();
                const firstInitial = nameParts[0].charAt(0).toUpperCase();
                lastNameFirstInitial = `${lastName}${firstInitial}`;
            } else if (travelerName.length > 0) {
                 lastNameFirstInitial = travelerName.toUpperCase(); // Handle single names
            }

            let formattedDate = 'NO_DATE';
            if (travelStart) {
                 try {
                    // Ensure date is parsed correctly, accounting for potential timezone issues if needed
                    const dateParts = travelStart.split('-'); // YYYY-MM-DD
                    const dateObj = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])); // Use UTC to avoid timezone shifts
                    const day = dateObj.getUTCDate().toString().padStart(2, '0');
                    const month = dateObj.toLocaleString('en-US', { month: 'short', timeZone: 'UTC' }).toUpperCase();
                    const year = dateObj.getUTCFullYear().toString().slice(-2);
                    formattedDate = `${day}_${month}_${year}`;
                 } catch (e) {
                     console.warn("Could not format date:", travelStart, e);
                     formattedDate = travelStart.replace(/-/g, '_'); // Fallback format
                 }
            }

            const fileName = `${uid}_HST_${lastNameFirstInitial}_${formattedDate}.pdf`;
            console.log(`Generated filename: ${fileName}`);

            // Serialize the PDF document
            console.log("Saving PDF document...");
            const pdfBytes = await pdfDoc.save();
            console.log("PDF Saved. Triggering download...");

            // Trigger download
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up

            console.log("Download triggered.");

        } catch (error) {
            console.error('Error during PDF generation:', error);
            alert(`An error occurred while processing the PDF: ${error.message}`);
        }
    });

</script>
</body>
</html>
